<script type="text/javascript">
    RED.nodes.registerType('system-node', {
        category: 'function',
        color: '#a6bbcf',
        defaults: {
            name: { value: "" },
            thingDirectoryURI: { value: "" },
            thingFunction: { value: "" },
            thingFunctionValue: { value: "" },
            outputToMsg: { value: true },
            redeploy: { value: "false" } //Only used to trigger UI redeploy
        },
        inputs: 1,
        inputLabels: "PLACEHOLDER",
        outputs: 1,
        icon: "bridge.svg",
        label: function () {
            return this.name || "system-node";
        },
        oneditprepare: function () {
            var node = this;

            if(node.thingFunctionValue === undefined) { //Ensure value is added to this node object
                node.thingFunctionValue = "";
            }

            $("#node-input-thingDirectoryURI").on("change", async function (event) {
                let input = $(this).val();

                let emptyInput = ["", undefined, null].includes(input);

                if (!emptyInput) {
                    await populateFunctions(input, node);
                }

                displayFunctionOption(!emptyInput);
            });

            function showFunctionOption() {
                $("div#function-row").show();
            }

            function hideFunctionOption() {
                $("#node-input-thingFunction").innerText = "";
                this.thingFunction = "";
                $("div#function-row").hide();
            }

            function displayFunctionOption(on) {
                if (on) {
                    showFunctionOption();
                } else {
                    hideFunctionOption();
                }
            }

            /**
             * @returns Boolean, the completion of this functionality
             */
            async function populateFunctions(tdURI, node) {
                emptyFunctionsSelect();

                let thingURIs = await fetchThingURIs(tdURI);
                let actionMap = await getActions(thingURIs);

                let functionSelect = document.getElementById("node-input-thingFunction");

                functionSelect.addEventListener("change", async function () { //Set thingFunction value to new selection
                    let selection = functionSelect.options[functionSelect.selectedIndex];
                    let actionObject = $(selection).data("value");

                    node.thingFunction = selection.text;
                    
                    let actionJSON = JSON.stringify(actionObject); //Access object in select's data-value

                    this.thingFunctionValue = actionJSON;
                    node.thingFunctionValue = actionJSON;

                    updateParameterLabels(actionObject);

                    enableDeploy();
                });

                let index = 0;
                for (let action of Object.keys(actionMap)) {
                    let option = document.createElement('option');

                    $(option).data("value", {
                        action : action,
                        uri : actionMap[action]["uri"],
                        params : actionMap[action]["params"]
                    }); //Map of action to Thing in data-value

                    option.innerHTML = action;

                    functionSelect.appendChild(option);

                    if (action === node.thingFunction) { //Select the thingFunction option
                        functionSelect.selectedIndex = index;
                    }

                    index++;
                }
            }

            function emptyFunctionsSelect() {
                $("select#node-input-thingFunction").empty();
            }

            async function fetchThingURIs(tdURI) {
                return fetch(tdURI + "/actions/getURIs", {
                    method: "POST"
                })
                .then((response) => {
                    return response.json();
                })
                .catch((reason) => {
                    throw reason;
                });
            }

            /**
             * Note: No action names may be duplicated in the system
             * @returns A map of action to the Thing URIs and list of parameters (along with their types is provided)
             */
            async function getActions(uriList) {
                let uriMap = {}; //Maps actions to the URIs they are associated with

                for (let uri of uriList) {
                    let actions = await fetchObject(uri, "actions");
                    if (actions === undefined) continue;

                    for (let action of Object.keys(actions)) {
                        uriMap[action] = {
                            "uri" : uri,
                            "params" : {}
                        }; //Note: Will override an action if a duplicate occurs

                        let params = actions[action]["input"];
                        if (params === undefined || params === null) continue;

                        for (let parameter of Object.keys(params)) {
                            let type = actions[action]["input"][parameter]["type"];
                            uriMap[action]["params"][parameter] = type; //Map parameter to it's type
                        }
                    }
                }

                return uriMap;
            }

            async function fetchObject(uri, key) {
                let response = await fetch(uri, {
                    method: "GET"
                })
                .then((response) => {
                    return response.json();
                })
                .catch((reason) => {
                    throw reason;
                });

                return response[key]; //Only allows keys from top-level
            }

            function enableDeploy() {
                let holder = document.getElementById("node-input-redeploy");
                
                if (holder.value !== "true") {
                    holder.value = "true";
                }
                else {
                    holder.value = "false";
                }
            }

            function updateParameterLabels(actionObject) {
                let params = actionObject["params"];

                let paramHolder = document.getElementById("label-parameters");
                paramHolder.innerText = formParameterText(params);
            }

            function formParameterText(params) {
                let text = "";
                
                for (let parameter of Object.keys(params)) {
                    text += parameter + " : " + params[parameter] + "\n";
                }

                return text.substring(0, text.length - 1);
            }
        }
    });
</script>

<script type="text/html" data-template-name="system-node">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-thingDirectoryURI"><i class="fa fa-tag"></i> Thing Directory</label>
        <input type="text" id="node-input-thingDirectoryURI" placeholder="http://localhost:8080/td">
    </div>
    <div id="function-row" class="form-row">
        <label for="node-input-thingFunction"><i class="fa fa-tag"></i> Thing Function</label>
        <select name="functionSelect" id="node-input-thingFunction">
            <option>Placeholder</option>
        </select>

        <div class="form-row">
            <label for="label-parameters"> Parameters</label>
            <label id="label-parameters"></label>
        </div>
    </div>
    <div class="form-row">
        <label for="node-input-outputToMsg"><i class="fa fa-tag"></i> Output to msg.payload</label>
        <input type="checkbox" checked id="node-input-outputToMsg" name="outputToMsg">
    </div>
    <input type="hidden" id="node-input-redeploy" name="holder">
</script>

<script type="text/html" data-help-name="system-node">
    <p>A node describing all Things held within its ThingDirectory</p>
</script>